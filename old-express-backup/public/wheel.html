<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Wheel - Zap Bot</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            overflow: hidden;
        }
        
        .header {
            text-align: center;
            margin-bottom: 2rem;
            z-index: 10;
        }
        
        .header h1 {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .stream-info {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 1rem;
        }
        
        .participant-count {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 1rem;
            backdrop-filter: blur(10px);
        }
        
        .wheel-container {
            position: relative;
            margin: 2rem 0;
        }
        
        .wheel {
            width: 400px;
            height: 400px;
            border-radius: 50%;
            border: 8px solid #fff;
            position: relative;
            box-shadow: 0 0 30px rgba(0,0,0,0.3);
            transition: transform 4s cubic-bezier(0.23, 1, 0.32, 1);
        }
        
        .wheel-segment {
            position: absolute;
            width: 50%;
            height: 50%;
            transform-origin: 100% 100%;
            overflow: hidden;
        }
        
        .wheel-segment:before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            border-radius: 50%;
            transform: rotate(45deg);
            transform-origin: 0 100%;
        }
        
        .wheel-segment .segment-text {
            position: absolute;
            top: 20%;
            right: 10%;
            font-weight: bold;
            font-size: 0.9rem;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
            transform: rotate(-45deg);
            white-space: nowrap;
            z-index: 1;
        }
        
        .wheel-pointer {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 30px solid #fff;
            z-index: 10;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
        
        .wheel-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            z-index: 5;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
        }
        
        .controls {
            text-align: center;
            margin-top: 2rem;
            z-index: 10;
        }
        
        .spin-button {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 1.5rem 3rem;
            border-radius: 50px;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .spin-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.4);
        }
        
        .spin-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .winner-display {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 3rem;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
            animation: popIn 0.5s ease-out;
        }
        
        .winner-display h2 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        
        .winner-display .winner-name {
            font-size: 3rem;
            font-weight: bold;
            margin: 1rem 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .winner-display .winner-amount {
            font-size: 1.5rem;
            opacity: 0.9;
        }
        
        .close-winner {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 10px;
            margin-top: 2rem;
            cursor: pointer;
        }
        
        .loading {
            text-align: center;
            font-size: 1.5rem;
            color: white;
        }
        
        .error {
            text-align: center;
            color: #ff6b6b;
            font-size: 1.2rem;
            background: rgba(255,255,255,0.1);
            padding: 1rem;
            border-radius: 10px;
            margin: 2rem;
        }
        
        @keyframes popIn {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        @keyframes sparkle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .sparkle {
            animation: sparkle 1s ease-in-out infinite;
        }
        
        @media (max-width: 768px) {
            .wheel {
                width: 300px;
                height: 300px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .spin-button {
                padding: 1rem 2rem;
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸŽ¡ Stream Wheel</h1>
        <div class="stream-info" id="streamInfo">Loading stream...</div>
        <div class="participant-count" id="participantCount">0 participants</div>
    </div>
    
    <div class="loading" id="loading">
        Loading participants...
    </div>
    
    <div class="wheel-container" id="wheelContainer" style="display: none;">
        <div class="wheel-pointer"></div>
        <div class="wheel" id="wheel"></div>
        <div class="wheel-center">âš¡</div>
    </div>
    
    <div class="controls" id="controls" style="display: none;">
        <button class="spin-button" id="spinButton">
            SPIN THE WHEEL
        </button>
    </div>
    
    <div class="error" id="error" style="display: none;"></div>
    
    <div class="winner-display" id="winnerDisplay">
        <h2>ðŸŽ‰ WINNER! ðŸŽ‰</h2>
        <div class="winner-name" id="winnerName"></div>
        <div class="winner-amount" id="winnerAmount"></div>
        <button class="close-winner" onclick="closeWinner()">Close</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const streamId = window.location.pathname.split('/').pop();
        
        let participants = [];
        let isSpinning = false;
        let currentRotation = 0;
        
        // Colors for wheel segments
        const segmentColors = [
            '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7',
            '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9',
            '#F8C471', '#82E0AA', '#F1948A', '#85C1E9', '#D7BDE2',
            '#A3E4D7', '#FAD7A0', '#D5A6BD', '#AED6F1', '#A9DFBF'
        ];
        
        // Join stream room
        socket.emit('join-stream', streamId);
        
        // Listen for new participants
        socket.on('new-participant', () => {
            loadParticipants();
        });
        
        // Listen for winner selections from admin
        socket.on('winner-selected', (data) => {
            showWinner(data.winner, data.amount);
        });
        
        async function loadStreamInfo() {
            try {
                const response = await fetch(`/api/streams/${streamId}`);
                if (!response.ok) throw new Error('Stream not found');
                
                const data = await response.json();
                document.getElementById('streamInfo').textContent = data.name;
                
            } catch (error) {
                showError('Stream not found or error loading stream info');
            }
        }
        
        async function loadParticipants() {
            try {
                const response = await fetch(`/api/streams/${streamId}/participants`);
                if (!response.ok) throw new Error('Failed to load participants');
                
                participants = await response.json();
                updateParticipantCount();
                buildWheel();
                
            } catch (error) {
                showError('Error loading participants: ' + error.message);
            }
        }
        
        function updateParticipantCount() {
            const count = participants.length;
            document.getElementById('participantCount').textContent = 
                `${count} participant${count !== 1 ? 's' : ''}`;
        }
        
        function buildWheel() {
            const wheelElement = document.getElementById('wheel');
            const loading = document.getElementById('loading');
            const wheelContainer = document.getElementById('wheelContainer');
            const controls = document.getElementById('controls');
            
            if (participants.length === 0) {
                loading.textContent = 'No participants yet. Share the check-in link!';
                wheelContainer.style.display = 'none';
                controls.style.display = 'none';
                return;
            }
            
            loading.style.display = 'none';
            wheelContainer.style.display = 'block';
            controls.style.display = 'block';
            
            // Clear existing segments
            wheelElement.innerHTML = '';
            
            const segmentAngle = 360 / participants.length;
            
            participants.forEach((participant, index) => {
                const segment = document.createElement('div');
                segment.className = 'wheel-segment';
                segment.style.transform = `rotate(${index * segmentAngle}deg)`;
                
                const segmentBefore = document.createElement('div');
                segmentBefore.style.position = 'absolute';
                segmentBefore.style.width = '200%';
                segmentBefore.style.height = '200%';
                segmentBefore.style.borderRadius = '50%';
                segmentBefore.style.transform = 'rotate(45deg)';
                segmentBefore.style.transformOrigin = '0 100%';
                segmentBefore.style.background = segmentColors[index % segmentColors.length];
                
                const text = document.createElement('div');
                text.className = 'segment-text';
                text.textContent = participant.username;
                text.style.transform = `rotate(${-index * segmentAngle - 45}deg)`;
                
                segment.appendChild(segmentBefore);
                segment.appendChild(text);
                wheelElement.appendChild(segment);
            });
        }
        
        function spinWheel() {
            if (isSpinning || participants.length === 0) return;
            
            isSpinning = true;
            const spinButton = document.getElementById('spinButton');
            spinButton.disabled = true;
            spinButton.textContent = 'SPINNING...';
            
            // Random spin: 3-5 full rotations + random final position
            const minSpins = 3;
            const maxSpins = 5;
            const spins = minSpins + Math.random() * (maxSpins - minSpins);
            const finalRotation = currentRotation + (spins * 360) + Math.random() * 360;
            
            const wheel = document.getElementById('wheel');
            wheel.style.transform = `rotate(${finalRotation}deg)`;
            currentRotation = finalRotation % 360;
            
            // Determine winner after spin completes
            setTimeout(() => {
                const segmentAngle = 360 / participants.length;
                const normalizedRotation = (360 - (currentRotation % 360)) % 360;
                const winnerIndex = Math.floor(normalizedRotation / segmentAngle);
                const winner = participants[winnerIndex];
                
                if (winner) {
                    // Highlight winner segment
                    const segments = document.querySelectorAll('.wheel-segment');
                    segments[winnerIndex].classList.add('sparkle');
                    
                    setTimeout(() => {
                        showWinner(winner.username, 1000); // Default amount
                    }, 1000);
                }
                
                // Reset button
                setTimeout(() => {
                    isSpinning = false;
                    spinButton.disabled = false;
                    spinButton.textContent = 'SPIN AGAIN';
                    
                    // Remove sparkle effect
                    document.querySelectorAll('.sparkle').forEach(el => {
                        el.classList.remove('sparkle');
                    });
                }, 2000);
                
            }, 4000); // Match CSS transition duration
        }
        
        function showWinner(winnerName, amount) {
            const winnerDisplay = document.getElementById('winnerDisplay');
            const winnerNameEl = document.getElementById('winnerName');
            const winnerAmountEl = document.getElementById('winnerAmount');
            
            winnerNameEl.textContent = winnerName;
            winnerAmountEl.textContent = `Wins ${amount} sats! âš¡`;
            
            winnerDisplay.style.display = 'block';
            
            // Auto-close after 10 seconds
            setTimeout(() => {
                closeWinner();
            }, 10000);
        }
        
        function closeWinner() {
            document.getElementById('winnerDisplay').style.display = 'none';
        }
        
        function showError(message) {
            const errorEl = document.getElementById('error');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('wheelContainer').style.display = 'none';
            document.getElementById('controls').style.display = 'none';
        }
        
        // Event listeners
        document.getElementById('spinButton').addEventListener('click', spinWheel);
        
        // Load initial data
        loadStreamInfo();
        loadParticipants();
        
        // Refresh participants every 30 seconds
        setInterval(loadParticipants, 30000);
        
        // Keyboard shortcut for spinning (spacebar)
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && !isSpinning) {
                e.preventDefault();
                spinWheel();
            }
        });
    </script>
</body>
</html> 